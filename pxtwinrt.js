var pxt;!function(e){!function(t){t.browserDownloadAsync=function(t,n,i){let r;return e.winrt.promisify(Windows.Storage.ApplicationData.current.temporaryFolder.createFileAsync(n,Windows.Storage.CreationCollisionOption.replaceExisting).then((e=>Windows.Storage.FileIO.writeTextAsync(r=e,t))).then((()=>Windows.System.Launcher.launchFileAsync(r))).then((e=>{})))},t.saveOnlyAsync=function(t){const n=e.appTarget.compile.useUF2,i=n?[".uf2"]:[".hex"],r=new Windows.Storage.Pickers.FileSavePicker;return r.suggestedStartLocation=Windows.Storage.Pickers.PickerLocationId.documentsLibrary,r.fileTypeChoices.insert("MakeCode binary file",i),r.suggestedFileName=t.downloadFileBaseName,e.winrt.promisify(r.pickSaveFileAsync().then((i=>{if(i){let r=n?t.outfiles[pxtc.BINARY_UF2]:t.outfiles[pxtc.BINARY_HEX];e.isOutputText()||(r=atob(r));const o=[];return e.Util.stringToUint8Array(r).forEach((e=>o.push(e))),Windows.Storage.FileIO.writeBytesAsync(i,o).then((()=>!0))}return Promise.resolve(!1)})))}}(e.winrt||(e.winrt={}))}(pxt||(pxt={})),function(e){!function(t){class n{constructor(){this.onDeviceConnectionChanged=e=>{},this.onConnectionChanged=()=>{},this.onData=e=>{},this.onEvent=e=>{},this.onError=e=>{},this.connecting=!1,this.handleInputReport=this.handleInputReport.bind(this)}disposeAsync(){return Promise.resolve()}error(t){throw new Error(e.U.lf("USB/HID error ({0})",t))}setConnecting(e){this.connecting=e,this.onConnectionChanged&&this.onConnectionChanged()}isConnecting(){return this.connecting}isConnected(){return!!this.dev}reconnectAsync(){return this.disconnectAsync().then((()=>this.initAsync()))}isSwitchingToBootloader(){s=!0,this.dev&&(a=!0)}disconnectAsync(){if(this.dev){const e=this.dev;delete this.dev;try{e.close()}catch(e){}this.onConnectionChanged&&this.onConnectionChanged()}return Promise.resolve()}sendPacketAsync(t){if(!this.dev)return Promise.resolve();const n=[0];for(let e=0;e<Math.max(t.length,64);++e)n.push(t[e]||0);const i=new Windows.Storage.Streams.DataWriter;i.writeBytes(n);const r=i.detachBuffer(),o=this.dev.createOutputReport(0);return o.data=r,e.winrt.promisify(this.dev.sendOutputReportAsync(o).then((e=>{})))}handleInputReport(e){const t=Windows.Storage.Streams.DataReader.fromBuffer(e.report.data),n=[];for(;t.unconsumedBufferLength;)n.push(t.readByte());65==n.length&&0===n[0]&&n.shift(),this.onData(new Uint8Array(n))}initAsync(n=!1){e.Util.assert(!this.dev,"HID interface not properly reseted");const r=Windows.Devices,o=r.HumanInterfaceDevice.HidDevice,s=()=>{const t=new Error(e.U.lf("Device not found"));return t.type="devicenotfound",Promise.reject(t)},a=i.reduce(((e,t)=>e.then((e=>e&&e.length?Promise.resolve(e):r.Enumeration.DeviceInformation.findAllAsync(t,null)))),Promise.resolve(null));let c;return this.setConnecting(!0),a.then((t=>{if(!t||!t[0])return e.debug("no hid device found"),Promise.reject(new Error("no hid device found"));e.debug(`hid enumerate ${t.length} devices`);const n=t[0];return e.debug(`hid connect to ${n.name} (${n.id})`),c=n.id,o.fromIdAsync(n.id,Windows.Storage.FileAccessMode.readWrite)})).then((t=>{if(this.dev=t,!this.dev){e.debug("can't connect to hid device");let t=Windows.Devices.Enumeration.DeviceAccessInformation.createFromId(c).currentStatus;return e.reportError("winrt_device",`could not connect to HID device; device status: ${t}`),Promise.reject(new Error("can't connect to hid device"))}return e.debug(`hid device version ${this.dev.version}`),this.dev.addEventListener("inputreportreceived",this.handleInputReport),Promise.resolve()})).finally((()=>{this.setConnecting(!1)})).catch((e=>n?s():t.bootloaderViaBaud(this).then((()=>this.initAsync(!0))).catch((()=>s()))))}}t.WinRTPacketIO=n,t.packetIO=void 0,t.mkWinRTPacketIOAsync=function(){return e.debug("packetio: mk winrt packetio"),t.packetIO=new n,t.packetIO.initAsync().catch((e=>(t.packetIO=void 0,Promise.reject(e)))).then((()=>t.packetIO))};const i=[],r=[];let o=0,s=!1,a=!1;t.initWinrtHid=function(n,c){const d=Windows.Devices,l=Windows.Devices.Enumeration.DeviceInformation,u=d.HumanInterfaceDevice.HidDevice;e.appTarget&&e.appTarget.compile&&e.appTarget.compile.hidSelectors&&e.appTarget.compile.hidSelectors.forEach((e=>{const t=u.getDeviceSelector(parseInt(e.usagePage),parseInt(e.usageId),parseInt(e.vid),parseInt(e.pid));i.indexOf(t)<0&&i.push(t)})),i.forEach((i=>{const d=l.createWatcher(i,null);d.addEventListener("added",(t=>{e.debug(`new hid device detected: ${t.id}`),s?s=!1:(++o,1===o&&n&&n())})),d.addEventListener("removed",(i=>{e.debug(`hid device closed: ${i.id}`),a?a=!1:(--o,o>0&&n?n():0===o&&c&&(c(),t.packetIO=void 0))})),d.addEventListener("updated",(e=>{})),r.push(d)})),r.filter((e=>!e.status)).forEach((e=>e.start()))}}(e.winrt||(e.winrt={}))}(pxt||(pxt={})),function(e){!function(t){let n,i,r={};function o(t){if(!t)return Promise.resolve([]);const n=Windows.Devices,i=n.SerialCommunication.SerialDevice,r=n.Enumeration.DeviceInformation,o=[];t.forEach((e=>{const t=i.getDeviceSelectorFromUsbVidPid(parseInt(e.vid),parseInt(e.pid));o.push(t)}));return o.reduce(((e,t)=>{let n;return e.then((e=>(n=e,r.findAllAsync(t,null)))).then((e=>{if(n)for(let t=0;t<e.length;++t)n.push(e[t]);else n=e;return Promise.resolve(n)}))}),Promise.resolve(null)).then((t=>t?e.U.promiseMapAll(t,(t=>e.winrt.promisify(i.fromIdAsync(t.id)))):Promise.resolve([])))}function s(t){i&&!i.test(t.name)||(e.debug(`serial port added ${t.name} - ${t.id}`),r[t.id]={info:t},Windows.Devices.SerialCommunication.SerialDevice.fromIdAsync(t.id).then((e=>{r[t.id].device=e,d(t.id)})))}function a(e){delete r[e.id]}function c(e){const t=r[e.id];t&&t.info.update(e)}t.initSerial=function(){const t=!!(e.appTarget.serial&&(e.appTarget.serial.nameFilter||e.appTarget.serial.vendorId&&e.appTarget.serial.productId));if(!(!!e.appTarget.serial&&e.appTarget.serial.log)||!t)return;const r=Windows.Devices.SerialCommunication.SerialDevice;let o;e.appTarget.serial.vendorId&&e.appTarget.serial.productId?o=r.getDeviceSelectorFromUsbVidPid(parseInt(e.appTarget.serial.vendorId),parseInt(e.appTarget.serial.productId)):(i=new RegExp(e.appTarget.serial.nameFilter),o=r.getDeviceSelector()),n=Windows.Devices.Enumeration.DeviceInformation.createWatcher(o,null),n.addEventListener("added",s),n.addEventListener("removed",a),n.addEventListener("updated",c),n.start()},t.suspendSerialAsync=function(){n&&(n.stop(),n.removeEventListener("added",s),n.removeEventListener("removed",a),n.removeEventListener("updated",c),n=void 0);let t=Promise.resolve();return Object.keys(r).forEach((n=>{const i=r[n],o=i.readingOperation;if(o){const n=e.Util.defer();i.cancellingDeferred=n,t=t.then((()=>e.U.promiseTimeout(500,n.promise).catch((t=>{e.reportError("winrt_device",`could not cancel reading operation for a device: ${t.message}`)})))),o.cancel()}})),t.then((()=>{Object.keys(r).forEach((e=>{const t=r[e];if(t.device){t.device.close()}})),r={}}))},t.bootloaderViaBaud=function(t){if(!(e.appTarget&&e.appTarget.compile&&e.appTarget.compile.useUF2&&e.appTarget.simulator&&e.appTarget.simulator.boardDefinition&&e.appTarget.simulator.boardDefinition.bootloaderBaudSwitchInfo))return Promise.reject(new Error("device does not support switching to bootloader via baudrate"));let n;const i=e.appTarget.simulator.boardDefinition.bootloaderBaudSwitchInfo;return o([{vid:i.vid,pid:i.pid,usageId:void 0,usagePage:void 0}]).then((i=>i&&0!==i.length?(n=i,n.length&&t.isSwitchingToBootloader(),n.forEach((e=>{e.baudRate=1200,e.close()})),e.U.delay(1500)):Promise.reject(new Error("no serial devices to switch into bootloader"))))},t.connectSerialDevicesAsync=o;function d(t){let n=r[t];if(!n)return;if(!n.device){let n=Windows.Devices.Enumeration.DeviceAccessInformation.createFromId(t).currentStatus;return void e.reportError("winrt_device",`could not connect to serial device; device status: ${n}`)}const i=Windows.Storage.Streams;n.device.baudRate=115200;let o=n.device.inputStream,s=new i.DataReader(o);s.inputStreamOptions=i.InputStreamOptions.partial;let a={},c=()=>{r[t]&&!n.cancellingDeferred&&(n.readingOperation=s.loadAsync(32),n.readingOperation.then((n=>{let i=s.readString(4*Math.floor(s.unconsumedBufferLength/4));e.Util.bufferSerial(a,i,t),setTimeout((()=>c()),1)}),(e=>{n.readingOperation.operation.status===Windows.Foundation.AsyncStatus.canceled?(s.detachStream(),s.close(),n.cancellingDeferred&&setTimeout((()=>n.cancellingDeferred.resolve()),25)):setTimeout((()=>d(t)),1e3)})))};setTimeout((()=>c()),100)}}(e.winrt||(e.winrt={}))}(pxt||(pxt={})),function(e){!function(t){function n(){return"undefined"!=typeof Windows}function i(){return n()?(c.resolve(null),c.promise.then((e=>Promise.resolve(e&&e.kind===Windows.ApplicationModel.Activation.ActivationKind.file)))):Promise.resolve(!1)}function r(){return n()?Promise.resolve().then((()=>t.packetIO?(e.log("disconnecting packetIO"),t.packetIO.disconnectAsync()):Promise.resolve())).catch((t=>{t.message=`error disconnecting packetIO: ${t.message}`,e.reportException(t)})).then((()=>(e.log("suspending serial"),t.suspendSerialAsync()))).catch((t=>{t.message=`error suspending serial: ${t.message}`,e.reportException(t)})):Promise.resolve()}function o(e){Windows.UI.WebUI.WebUIApplication.removeEventListener("activated",o),c.resolve(e)}function s(t){e.log("suspending");const n=t.suspendingOperation.getDeferral();return r().then((()=>n.complete()),(e=>n.complete())).then()}function a(n){e.log("resuming"),t.packetIO&&(e.log("reconnet pack io"),t.packetIO.reconnectAsync()),t.initSerial()}let c,d;function l(t,n=!1){if(t.kind===Windows.ApplicationModel.Activation.ActivationKind.file){let i=t.files.getAt(0);if(i&&i.isOfType(Windows.Storage.StorageItemTypes.file)){let t=i;Windows.Storage.FileIO.readBufferAsync(t).then((t=>{let n=[],i=Windows.Storage.Streams.DataReader.fromBuffer(t);for(;i.unconsumedBufferLength;)n.push(i.readByte());return i.close(),e.cpp.unpackSourceFromHexAsync(new Uint8Array(n))})).then((e=>d(e,{openHomeIfFailed:n})))}}}e.BrowserUtils.isWinRT=n,t.promisify=function(e){return new Promise(((t,n)=>{e.then((e=>t(e)),(e=>n(e)))}))},t.toArray=function(e){let t=[],n=e.length;for(let i=0;i<n;++i)t.push(e[i]);return t},t.isWindows=function(){return!!navigator&&/Win32/i.test(navigator.platform)},t.isWinRT=n,t.initAsync=function(r){if(!n()||e.BrowserUtils.isIFrame())return Promise.resolve();const c=Windows.UI.Core,u=c.SystemNavigationManager.getForCurrentView(),p=Windows.UI.WebUI.WebUIApplication;return p.addEventListener("suspending",s),p.addEventListener("resuming",a),u.onbackrequested=t=>{e.log("BACK NAVIGATION"),u.appViewBackButtonVisibility=c.AppViewBackButtonVisibility.collapsed,t.handled=!0},t.initSerial(),i().then((()=>{r&&(d=r,p.removeEventListener("activated",o),p.addEventListener("activated",l))}))},t.captureInitialActivation=function(){if(!n())return;c=e.Util.defer(),Windows.UI.WebUI.WebUIApplication.addEventListener("activated",o)},t.loadActivationProject=function(){return c.promise.then((e=>l(e,!0)))},t.hasActivationProjectAsync=i,t.releaseAllDevicesAsync=r}(e.winrt||(e.winrt={}))}(pxt||(pxt={})),function(e){!function(t){!function(n){var i=e.Util;let r;function o(...e){return e.join("\\")}function s(n){const i=o(r.path,n);return e.debug(`winrt: reading ${i}`),t.promisify(Windows.Storage.StorageFile.getFileFromPathAsync(i).then((e=>Windows.Storage.FileIO.readTextAsync(e))))}function a(n,i,s){const a=o(r.path,n);return e.debug(`winrt: writing ${o(a,i)}`),t.promisify(Windows.Storage.StorageFolder.getFolderFromPathAsync(a)).then((e=>e.createFileAsync(i,Windows.Storage.CreationCollisionOption.replaceExisting))).then((e=>Windows.Storage.FileIO.writeTextAsync(e,s))).then((()=>{}))}function c(e,t=null){let n=new Error(t||"Error "+e);throw n.statusCode=e,n}n.fileApiAsync=function(n,p){if(i.startsWith(n,"pkg/")){let u=n.slice(4);return p?function(n,u){return e.debug(`winrt: writing package at ${n}`),t.promisify(r.createFolderAsync(n,Windows.Storage.CreationCollisionOption.openIfExists)).then((()=>i.promiseMapAll(u.files,(t=>s(o(n,t.name)).then((n=>{if(t.name!=e.SIMSTATE_JSON&&t.name!=e.ASSETS_FILE){if(t.name==e.CONFIG_NAME)try{JSON.parse(t.content).name||(e.log("Trying to save invalid JSON config"),c(410))}catch(t){e.log("Trying to save invalid format JSON config"),c(410)}n!==t.prevContent&&(e.log(`merge error for ${t.name}: previous content changed...`),c(409))}}),(e=>{})))))).then((()=>i.promiseMapAll(u.files,(e=>a(n,e.name,e.content))))).then((()=>a(n,d,JSON.stringify(u.header,null,4)))).then((()=>l(n,!1)))}(u,p):l(u,!0)}if("list"==n)return function(){if(r)return Promise.resolve();const n=Windows.Storage.ApplicationData.current.localFolder;return e.debug("winrt: initializing workspace"),t.promisify(n.createFolderAsync(e.appTarget.id,Windows.Storage.CreationCollisionOption.openIfExists)).then((t=>{r=t,e.debug(`winrt: initialized workspace at ${r.path}`)})).then((()=>{}))}().then(u);throw c(404)};const d=".header.json";function l(n,a){return e.debug(`winrt: reading package under ${n}`),s(o(n,e.CONFIG_NAME)).then((c=>{const l=JSON.parse(c);return i.promiseMapAll(e.allPkgFiles(l),(i=>function(n){const i=o(r.path,n);return e.debug(`winrt: ${i}`),t.promisify(Windows.Storage.StorageFile.getFileFromPathAsync(i).then((e=>e.getBasicPropertiesAsync().then((e=>({name:n,mtime:e.dateModified.getTime()}))))))}(o(n,i)).then((e=>{const t={name:i,mtime:e?e.mtime:null};return null!=e&&a?s(o(n,i)).then((e=>(t.content=e,t))):t})))).then((e=>{const t={path:n,header:null,config:l,files:e};return s(o(n,d)).then((e=>{e&&(t.header=JSON.parse(e))}),(e=>{})).then((()=>t))}))}))}function u(){return t.promisify(r.getFoldersAsync()).then((e=>i.promiseMapAll(e,(e=>l(e.name,!1))))).then((e=>Promise.resolve({pkgs:e})))}function p(){return t.promisify(r.deleteAsync(Windows.Storage.StorageDeleteOption.default).then((()=>{r=void 0})))}n.getProvider=function(e){return{listAsync:e.listAsync,getAsync:e.getAsync,setAsync:e.setAsync,resetAsync:p}}}(t.workspace||(t.workspace={}))}(e.winrt||(e.winrt={}))}(pxt||(pxt={}));